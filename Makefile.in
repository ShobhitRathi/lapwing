# Common prefix for installation directories
# arch-independent
includedir := $(prefix)/include
# arch-dependent
exec_prefix := $(prefix)
libdir := $(exec_prefix)/lib

# lapwing project specific vars and rules
prog := liblapwing.so
src := $(wildcard src/*.c)
obj := $(src:.c=.o)

CFLAGS := -ansi -Wall -Wextra -Wpedantic -Wpadded -Werror $(debug)
INCLUDE := -I./include/

# "test" rule flags
tests_src := $(wildcard tests/*.c)
tests_prog := $(tests_src:.c=.out)

ifdef ($(valgrind))
	VFLAGS := "--tool=memcheck --quiet --leak-check=full --error-exitcode=1"
	valgrind_prog := valgrind $(VFLAGS)
endif

INCLUDE_TEST := $(INCLUDE) -I./tests/unity/
LDFLAGS_TEST := -L$(DESTDIR)$(prefix)/lib -llapwing

# targets
all: $(prog) $(test_progs)
	@echo $^ generated

$(prog): $(obj)
	$(CC) -shared $(CFLAGS) -o $@ $^

src/%.o: src/%.c
	$(CC) -fPIC $(INCLUDE) $(CFLAGS) -o $@ -c $<

tests/%.out: tests/%.c
	$(CC) $(INCLUDE_TEST) $(LDFLAGS_TEST) $(CFLAGS) -o $@ tests/unity/unity.c $<

.PHONY: clean install uninstall test
clean:
	rm -f $(obj) $(prog) $(tests_prog)

install: $(prog)
	install -D -m 755 liblapwing.so $(DESTDIR)$(prefix)/lib/liblapwing.so
	install -d $(DESTDIR)$(prefix)/include/lapwing
	install -D -m 644 include/lapwing/* $(DESTDIR)$(prefix)/include/lapwing

uninstall:
	rm -f $(DESTDIR)$(prefix)/lib/lapwing.so
	rm -rf $(DESTDIR)$(prefix)/include/lapwing

test: $(tests_prog) install
	@echo '=== RUNNING UNIT TESTS ==='
	@for test_out in $(tests_prog); do \
		echo ">>> unit: $$test_out"; \
		LD_LIBRARY_PATH=$(DESTDIR)$(prefix)/lib $(valgrind_prog) ./$$test_out; \
	done
	@echo '=== END OF UNIT TESTS ==='
